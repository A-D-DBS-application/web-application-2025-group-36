{% extends "base.html" %}
{% block content %}

{% set pdf_url = url_for('main.download_paper', paper_id=paper.paper_id) %}

<div class="paper-header">
    
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
        <span class="tag tag-accent">Research Paper</span>
        <span class="tag tag-dashed" style="border-color: var(--accent); color: var(--accent);">{{ paper.research_domain }}</span>
        {% for link in paper.companies %}
            <span class="tag tag-gray">üè• {{ link.company.name }}</span>
        {% endfor %}
    </div>

    <h1 class="paper-title">
        {{ paper.title }}
    </h1>
    
    <p style="max-width: 60rem; font-size: 1.1rem;">
        {{ paper.abstract }}
    </p>

    <div class="paper-actions">
        <a href="{{ pdf_url }}" target="_blank" class="btn btn-primary">
            Download PDF
        </a>

        <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">
            ‚Üê Back to archive
        </a>

        {% if session.get("user_id") == paper.user_id or session.get("user_role") in ["System/Admin", "Founder"] %}
        <div style="margin-left: auto; display: flex; gap: 0.75rem;">
            <a href="{{ url_for('main.update_paper', paper_id=paper.paper_id) }}" class="btn btn-warning">
                Edit
            </a>
            <form method="POST" action="{{ url_for('main.delete_paper', paper_id=paper.paper_id) }}">
                <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this paper?');">
                    Delete
                </button>
            </form>
        </div>
        {% endif %}
    </div>

</div>

<div class="paper-content-grid">

    <div>
        
        <div class="meta-grid">
            <div class="meta-box">
                <div class="meta-label">Uploaded</div>
                <div class="meta-value">{{ paper.upload_date.strftime('%d %b %Y') if paper.upload_date else '' }}</div>
            </div>
            <div class="meta-box">
                <div class="meta-label">AI Status</div>
                <div class="meta-value">
                    {% if paper.ai_status == "pending" %} ‚è≥ Pending
                    {% elif paper.ai_status == "done" %} ‚úÖ Completed
                    {% elif paper.ai_status == "failed" %} ‚ùå Failed
                    {% else %} ‚Äî None {% endif %}
                </div>
            </div>
            <div class="meta-box">
                <div class="meta-label">Author</div>
                <div class="meta-value">{{ paper.author.name if paper.author else "Unknown" }}</div>
            </div>
        </div>

        <div style="margin-bottom: 3rem;">
            <h2 style="margin-bottom: 1.5rem;">AI Analysis</h2>

            {% if paper.ai_status == "done" %}
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="analysis-card green" style="text-align: center;">
                        <div class="meta-label">Business Score</div>
                        <div style="font-size: 2.5rem; font-weight: 800; color: #15803d; line-height: 1;">
                            {{ paper.ai_business_score }}
                        </div>
                    </div>
                    <div class="analysis-card blue" style="text-align: center;">
                        <div class="meta-label">Academic Score</div>
                        <div style="font-size: 2.5rem; font-weight: 800; color: #1d4ed8; line-height: 1;">
                            {{ paper.ai_academic_score }}
                        </div>
                    </div>
                </div>

                <div class="analysis-card gray">
                    <h3>Summary</h3>
                    <p>{{ paper.ai_summary }}</p>
                </div>

                <div style="display: grid; gap: 1rem; margin-top: 1rem;">
                     <div class="analysis-card gray">
                        <h3>Strengths</h3>
                        <p style="white-space: pre-line;">{{ paper.ai_strengths }}</p>
                     </div>
                     <div class="analysis-card gray">
                        <h3>Weaknesses</h3>
                        <p style="white-space: pre-line;">{{ paper.ai_weaknesses }}</p>
                     </div>
                </div>

            {% elif paper.ai_status == "pending" %}
                <div class="alert alert-info">
                    ‚è≥ <strong>Analysis in progress.</strong> Refresh the page in a few seconds.
                </div>
            {% elif paper.ai_status == "failed" %}
                <div class="alert alert-error">
                    ‚ùå <strong>Analysis failed.</strong> The AI could not process this paper.
                </div>
            {% else %}
                <div class="alert alert-info">AI analysis unavailable.</div>
            {% endif %}
        </div>

        <div id="report-block" class="report-block">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
                <div>
                    <div class="meta-label">FLAG THIS PAPER</div>
                    <h3>Report a concern</h3>
                    <p style="margin: 0; font-size: 0.9rem;">Raise issues like plagiarism, inappropriate content, or data integrity.</p>
                </div>
                <button id="toggle-report-panel" class="btn btn-danger">
                    Report paper
                </button>
            </div>

            <div id="report-panel" class="hidden" style="margin-top: 1.5rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem;">
                <form method="post" action="{{ url_for('main.submit_complaint', paper_id=paper.paper_id) }}" style="display: grid; gap: 1rem;">
                    
                    <div>
                        <label class="form-label">Type of issue</label>
                        <select name="complaint_category" class="form-control">
                            <option value="Plagiarism">Plagiarism</option>
                            <option value="Ethics / Compliance">Ethics / Compliance</option>
                            <option value="Data quality">Data quality</option>
                            <option value="Inappropriate content">Inappropriate content</option>
                            <option value="Other" selected>Other</option>
                        </select>
                    </div>

                    <div>
                        <label class="form-label">Describe the issue</label>
                        <textarea name="complaint_description" rows="4" class="form-control" required placeholder="Provide detail..."></textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label class="form-label">Your name (optional)</label>
                            <input type="text" name="reporter_name" value="{{ session.get('user_name', '') }}" class="form-control" placeholder="Anonymous">
                        </div>
                        <div>
                             <label class="form-label">Contact email (optional)</label>
                             <input type="email" name="reporter_email" class="form-control" placeholder="For follow up">
                        </div>
                    </div>

                    <div class="alert alert-info" style="font-size: 0.85rem;">
                         Reports are confidential and reviewed by moderators.
                    </div>

                    <div style="text-align: right;">
                        <button type="submit" class="btn btn-primary">Submit report</button>
                    </div>
                </form>
            </div>
            
            {% if complaint_submitted %}
            <div id="complaint-confirmation" class="alert alert-success" style="margin-top: 1rem; justify-content: space-between;">
                <span>‚úì Complaint received. Thank you.</span>
                <button type="button" onclick="document.getElementById('complaint-confirmation')?.remove();" style="background:none; border:none; cursor:pointer;">‚úï</button>
            </div>
            {% endif %}

            {% if can_view_complaints %}
            <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <h4>Recent reports ({{ complaints|length }})</h4>
                {% if complaints %}
                    {% for c in complaints %}
                    <div style="background: #f9fafb; padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 0.9rem;">
                            <span>{{ c.category }}</span>
                            <span style="color: var(--text-muted);">{{ c.created_at.strftime('%d %b %Y') }}</span>
                        </div>
                        <p style="margin: 0.5rem 0; font-size: 0.9rem;">{{ c.description }}</p>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No reports yet.</p>
                {% endif %}
            </div>
            {% endif %}

        </div>

    </div>

    <div>
        <div class="sidebar-card">
            <h3 class="sidebar-title">Review / Score</h3>
            <p class="sidebar-text">
                Submit a score out of 10 and a comment regarding this research.
            </p>

            {% if can_review %}
            <form method="post" style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                    <label class="sidebar-label">Score (0‚Äì10)</label>
                    <input type="number" name="score" step="0.1" min="0" max="10" class="form-control sidebar-input">
                </div>

                <div>
                    <label class="sidebar-label">Comment</label>
                    <textarea name="comments" rows="4" class="form-control sidebar-input" placeholder="Feedback..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    Publish review
                </button>
            </form>
            {% else %}
            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                <p style="margin: 0; color: #d1d5db;">Log in to review.</p>
            </div>
            {% endif %}
        </div>
    </div>

</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const toggleButton = document.getElementById("toggle-report-panel");
    const panel = document.getElementById("report-panel");

    if (toggleButton && panel) {
      toggleButton.addEventListener("click", () => {
        panel.classList.toggle("hidden");
        // Simple toggle for the 'hidden' class defined in your general CSS or just inline style
        if(panel.style.display === 'none' || panel.classList.contains('hidden')) {
             panel.style.display = 'grid';
             panel.classList.remove('hidden');
        } else {
             panel.style.display = 'none';
             panel.classList.add('hidden');
        }
      });
    }

    if (window.location.hash === "#report-block" && panel) {
       panel.style.display = 'grid';
       panel.classList.remove('hidden');
    }
  });
</script>

<style> .hidden { display: none !important; } </style>

{% endblock %}