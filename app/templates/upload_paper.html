{% extends "base.html" %}
{% block content %}

<div class="upload-header">
    <div class="tag tag-accent" style="margin-bottom: 1rem;">
        AI Assisted
    </div>
    <h1>
        Upload & <span class="text-gradient">Analyze</span>
    </h1>
    <p>
        Submit your research paper. Our AI will analyze the content while you wait and prepare the scores.
    </p>
</div>

<section class="upload-card">
    
    <form id="uploadForm"
          action="{{ url_for('main.upload_paper') }}"
          method="post"
          enctype="multipart/form-data"
          onsubmit="showLoader()">
        
        <div class="upload-layout">

            <div class="upload-details">
                
                <h3 class="upload-section-title">
                    <span>üìù</span> Paper Details
                </h3>

                <div class="form-stack">
                    <div>
                        <label class="form-label">Paper Title</label>
                        <input type="text" name="title" required class="form-control" placeholder="e.g. Advances in Robotics...">
                    </div>

                    <div>
                        <label class="form-label">Abstract</label>
                        <textarea name="abstract" required rows="5" class="form-control" placeholder="Paste the abstract here..."></textarea>
                        <p class="form-help">The AI uses this to double-check the domain analysis.</p>
                    </div>

                    <div class="form-grid-2" style="margin-top: 0; gap: 1rem;">
                        <div>
                            <label class="form-label">Research Domain</label>
                            <select name="research_domain" class="form-control">
                                {% for d in domains %}
                                <option value="{{ d }}">{{ d }}</option>
                                {% endfor %}
                                <option value="Other">Other</option>
                            </select>
                            <input type="text" name="custom_domain" placeholder="If other, specify..." class="form-control" style="margin-top: 0.5rem; font-size: 0.85rem;">
                        </div>

                        <div>
                            <label class="form-label">Research Facility</label>
                            <select name="company_id" class="form-control">
                                <option value="">-- Independent --</option>
                                {% for company in companies %}
                                <option value="{{ company.company_id }}">{{ company.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="new-facility-box">
                        <p class="stat-label-simple">Or register new facility</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <input type="text" name="new_company" placeholder="New Lab Name" class="form-control" style="font-size: 0.9rem;">
                            <input type="text" name="new_company_industry" placeholder="Focus Area" class="form-control" style="font-size: 0.9rem;">
                        </div>
                    </div>
                </div>

            </div>

            <div class="upload-drop-area">
                
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="width: 4rem; height: 4rem; background-color: white; border-radius: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 1rem auto; color: var(--accent);">
                        üìÑ
                    </div>
                    <h3>Upload PDF</h3>
                    <p style="font-size: 0.9rem; color: var(--text-muted);">Max file size: 16 MB</p>
                </div>

                <div id="dropzone" class="dropzone">
                    <input type="file"
                           id="file-input"
                           name="file"
                           accept="application/pdf"
                           required
                           class="dropzone-input"
                           onchange="updateFileName(this)">
                    
                    <div style="text-align: center; pointer-events: none; padding: 1rem;">
                        <p id="file-label-main" style="font-weight: 700; color: var(--text-main);">
                            Drag & Drop or Click
                        </p>
                        <p id="file-label-sub" style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                            .PDF files only
                        </p>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-lg btn-shimmer" style="width: 100%; margin-top: 2rem; padding: 1rem;">
                    üöÄ Analyze & Submit
                </button>

            </div>

        </div>
    </form>
</section>

<div id="ai-loader" class="loader-overlay">
    
    <div class="loader-circle-container">
        <div class="loader-ring"></div>
        <div class="loader-ring-spin"></div>
        <div style="position: absolute; inset: 1rem; background-color: rgba(59, 191, 181, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <span style="font-size: 2.5rem;">ü§ñ</span>
        </div>
    </div>

    <h2 style="margin-bottom: 0.5rem;">Analyzing Paper...</h2>
    <p style="color: var(--text-muted); font-size: 1.1rem; font-weight: 500;" id="loading-text">
        Connecting to AI Neural Network...
    </p>

    <div class="loader-bar-container">
        <div class="loader-bar-fill"></div>
    </div>
</div>

<script>
    function updateFileName(input) {
        if (input.files && input.files.length > 0) {
            const fileName = input.files[0].name;
            const mainLabel = document.getElementById('file-label-main');
            mainLabel.textContent = fileName;
            mainLabel.style.color = 'var(--accent)';
            document.getElementById('file-label-sub').textContent = "Ready to upload";
            
            // Add active class to parent dropzone
            input.parentElement.classList.add('active');
        }
    }

    function showLoader() {
        const loader = document.getElementById('ai-loader');
        loader.classList.add('flex'); // Add flex class to show it

        const texts = [
            "Parsing abstract and metadata...",
            "Categorizing research domain...",
            "Calculating Business Potential...",
            "Evaluating Academic Rigor...",
            "Finalizing scores..."
        ];
        
        let i = 0;
        const textElement = document.getElementById('loading-text');
        
        setInterval(() => {
            if (i < texts.length) {
                textElement.innerText = texts[i];
                i++;
            }
        }, 1200);
    }

    // --------- DRAG & DROP SUPPORT ----------
    document.addEventListener("DOMContentLoaded", function () {
        const dropzone = document.getElementById("dropzone");
        const fileInput = document.getElementById("file-input");

        if (!dropzone || !fileInput) return;

        // Prevent browser opening file
        ["dragover", "drop"].forEach(eventName => {
            window.addEventListener(eventName, function (e) {
                e.preventDefault();
            });
        });

        ["dragenter", "dragover", "dragleave", "drop"].forEach(eventName => {
            dropzone.addEventListener(eventName, function (e) {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        dropzone.addEventListener("dragover", function () {
            dropzone.classList.add("active");
        });

        dropzone.addEventListener("dragleave", function () {
            // Only remove if no file selected yet, or strictly on leave
            // Ideally we check if file input is empty, but simple toggle is okay
             if (!fileInput.files.length) {
                dropzone.classList.remove("active");
             }
        });

        dropzone.addEventListener("drop", function (e) {
            const files = e.dataTransfer && e.dataTransfer.files;
            
            // Remove active hover state (will re-add if valid file)
            dropzone.classList.remove("active");

            if (!files || !files.length) return;

            try {
                fileInput.files = files;
            } catch (err) {
                console.warn("Could not assign files programmatically:", err);
            }
            updateFileName(fileInput);
        });
    });
</script>

{% endblock %}