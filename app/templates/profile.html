{% extends "base.html" %}
{% block content %}

<div class="profile-header">
    <div class="profile-cover"></div>
    
    <div class="profile-content">
        <div style="display: flex; align-items: center; gap: 1.5rem;">
            <div class="profile-avatar">
                {{ user.name[0] | upper }}
            </div>
            
            <div style="padding-top: 0.5rem;">
                <h1 style="font-size: 1.5rem; margin-bottom: 0.5rem;">{{ user.name }}</h1>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
                    {% if user.role == 'Researcher' %}
                        <span class="tag" style="background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe;">Researcher</span>
                    {% elif user.role == 'Company' %}
                        <span class="tag" style="background: #f0fdfa; color: #0f766e; border: 1px solid #ccfbf1;">Company</span>
                    {% else %}
                        <span class="tag tag-gray">{{ user.role }}</span>
                    {% endif %}

                    {% if company %}
                        <span style="width: 4px; height: 4px; background: #d1d5db; border-radius: 50%;"></span>
                        <span style="font-size: 0.85rem; color: var(--text-muted);">Company <strong>{{ company.name }}</strong></span>
                    {% endif %}
                </div>
            </div>
        </div>

        <div>
            <a href="{{ url_for('main.edit_profile') }}" class="btn btn-secondary">
                Profile settings
            </a>
        </div>
    </div>
</div>

<div class="profile-stats-grid">
    <div class="stat-card-simple">
        <div class="stat-label-simple">Reviews given</div>
        <div class="stat-value-simple">{{ reviews_count }}</div>
    </div>

    <div class="stat-card-simple">
        <div class="stat-label-simple">
            {% if user.role == 'Company' %}Papers marked as interesting{% else %}Active domains{% endif %}
        </div>
        <div class="stat-value-simple">
            {% if user.role == 'Company' %}
                {{ interested_papers|length }}
            {% else %}
                {{ user.reviews|map(attribute='paper')|selectattr('research_domain')|list|length }}
            {% endif %}
        </div>
    </div>
</div>

{# --- CASE 1: COMPANY USER --- #}
{% if user.role == 'Company' %}

    {# RECOMMENDED #}
    {% if recommended_papers %}
    <section style="margin-bottom: 3rem;">
        <h2 style="font-size: 1.25rem; margin-bottom: 0.5rem;">ðŸŽ¯ Recommended for {{ company.name or user.name }}</h2>
        <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1.5rem;">
            Based on your interests: 
            {% if company and company.interests %}
                <span class="text-accent" style="font-weight: 600;">{{ company.interests }}</span>
            {% endif %}
        </p>

        <div>
            {% for paper in recommended_papers %}
                <div class="compact-card highlight">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <a href="{{ url_for('main.paper_detail', paper_id=paper.paper_id) }}" style="font-weight: 600; font-size: 1.1rem;">
                            {{ paper.title }}
                        </a>
                        <span class="tag" style="background: white; border: 1px solid var(--border-color);">{{ paper.research_domain }}</span>
                    </div>

                    <p style="font-size: 0.9rem; color: #4b5563; margin-bottom: 0.75rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-clamp: 2;">
                        {{ paper.abstract or "No abstract provided." }}
                    </p>

                    <div style="font-size: 0.8rem; color: var(--text-muted); display: flex; gap: 0.75rem; align-items: center;">
                        {% if paper.author %}<span>by {{ paper.author.name }}</span>{% endif %}
                        {% if paper.upload_date %}<span>â€¢ {{ paper.upload_date.strftime('%b %d, %Y') }}</span>{% endif %}
                        {% if paper.ai_status == 'done' %}
                            <span style="color: #16a34a; font-weight: 600;">â€¢ AI scored</span>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {# SAVED INTEREST #}
    <section>
        <h2 style="font-size: 1.1rem; margin-bottom: 1rem;">Saved interest</h2>
        
        {% if interested_papers %}
            <div>
                {% for paper in interested_papers %}
                    <div class="compact-card">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <a href="{{ url_for('main.paper_detail', paper_id=paper.paper_id) }}" style="font-weight: 600;">
                                {{ paper.title }}
                            </a>
                            
                            <form method="post" action="{{ url_for('main.toggle_interest', paper_id=paper.paper_id) }}">
                                <button type="submit" class="btn btn-secondary btn-sm" style="font-size: 0.75rem; padding: 0.25rem 0.75rem;">
                                    Remove
                                </button>
                            </form>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem; font-size: 0.8rem; color: var(--text-muted);">
                             <span class="tag tag-gray" style="font-size: 0.7rem;">{{ paper.research_domain }}</span>
                             {% if paper.author %}<span>by {{ paper.author.name }}</span>{% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="text-align: center; padding: 2rem; border: 1px dashed var(--border-color); border-radius: 1rem; background-color: #f9fafb;">
                <p style="margin-bottom: 0.5rem; color: var(--text-muted);">No papers saved as interesting yet.</p>
                <a href="{{ url_for('main.dashboard') }}" class="text-accent">Explore the dashboard</a>
            </div>
        {% endif %}
    </section>

{# --- CASE 2: REGULAR USER --- #}
{% else %}

<div style="display: grid; gap: 2rem;">
    <style> @media (min-width: 1024px) { .user-content-split { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; } } </style>
    
    <div class="user-content-split">
        
        {# My Papers #}
        <section>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 style="font-size: 1.1rem;">My papers <span style="font-weight: 400; color: var(--text-muted);">({{ authored_papers|length }})</span></h2>
                <a href="{{ url_for('main.upload_paper') }}" class="text-accent" style="font-size: 0.9rem; font-weight: 600;">New upload</a>
            </div>

            {% if authored_papers %}
                {% for paper in authored_papers %}
                    <div class="compact-card">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span class="tag tag-gray" style="font-size: 0.7rem;">{{ paper.research_domain }}</span>
                            <a href="{{ url_for('main.update_paper', paper_id=paper.paper_id) }}" style="font-size: 0.75rem; color: var(--text-muted);">Edit</a>
                        </div>
                        
                        <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">
                            <a href="{{ url_for('main.paper_detail', paper_id=paper.paper_id) }}">{{ paper.title }}</a>
                        </h3>
                        
                        <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.5rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                             {{ paper.abstract or 'No abstract' }}
                        </p>
                        
                        <div style="font-size: 0.75rem; color: var(--text-muted);">
                             {{ paper.upload_date.strftime('%b %d, %Y') if paper.upload_date else '' }}
                             {% if paper.ai_status == 'done' %} <span style="color: #16a34a; margin-left: 0.5rem;">AI scored</span> {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: 2rem; border: 1px dashed var(--border-color); border-radius: 1rem; background-color: #f9fafb;">
                    <p style="margin-bottom: 0.5rem; color: var(--text-muted);">You havenâ€™t published any papers yet.</p>
                    <a href="{{ url_for('main.upload_paper') }}" class="text-accent">Upload your first paper</a>
                </div>
            {% endif %}
        </section>

        {# My Reviews #}
        <section>
            <h2 style="font-size: 1.1rem; margin-bottom: 1rem;">My reviews</h2>
            {% if reviews %}
                {% for review in reviews[:5] %}
                    <div class="compact-card">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.8rem;">
                            <span style="color: var(--text-muted);">{{ review.date_submitted.strftime('%d %b %Y') if review.date_submitted else '' }}</span>
                            <span>Score: <strong>{{ review.score }}/10</strong></span>
                        </div>
                        
                        <h4 style="font-size: 0.95rem; margin-bottom: 0.5rem;">
                             <a href="{{ url_for('main.paper_detail', paper_id=review.paper.paper_id) }}" class="text-accent">{{ review.paper.title }}</a>
                        </h4>
                        
                        {% if review.comments %}
                            <div style="background: #f9fafb; padding: 0.5rem; border-radius: 0.5rem; font-size: 0.85rem; color: #4b5563;">
                                {{ review.comments[:100] }}...
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: 2rem; border: 1px dashed var(--border-color); border-radius: 1rem; background-color: #f9fafb;">
                    <p style="margin-bottom: 0.5rem; color: var(--text-muted);">No reviews yet.</p>
                    <a href="{{ url_for('main.dashboard') }}" class="text-accent">Start reviewing</a>
                </div>
            {% endif %}
        </section>
        
    </div>
</div>

{% endif %}

<section class="danger-section">
    <div class="danger-card">
        <div>
            <h3 style="font-size: 1rem; font-weight: 600; color: #b91c1c; margin-bottom: 0.25rem;">Delete account</h3>
            <p style="font-size: 0.85rem; color: #991b1b; opacity: 0.8; margin: 0;">
                This will permanently remove your account and all associated data. This action cannot be undone.
            </p>
        </div>
        
        <form method="post" action="{{ url_for('main.delete_account') }}" onsubmit="return confirm('Are you sure you want to permanently delete your account? This cannot be undone.');">
            <button type="submit" class="btn btn-sm" style="background-color: white; border: 1px solid #fca5a5; color: #dc2626;">
                Delete account
            </button>
        </form>
    </div>
</section>

{% endblock %}